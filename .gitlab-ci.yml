.docker_login:
  before_script: |
    echo "${CI_REGISTRY_PASSWORD}" \
    | docker login "${CI_REGISTRY}" \
        --username="${CI_REGISTRY_USER}" \
        --password-stdin

.docker_logout:
  after_script: |
    docker logout "${CI_REGISTRY}"

.dind:
  variables:
    DOCKER_CERT_DIR: ""
  services:
  - name: docker:29.2.1-dind@sha256:8bcbad4b45f0bff9d3e809d85a7ac589390f0be8acbc526850c998c35c1243fd

.uniget:
  before_script: |
    apk add --update-cache \
        curl
  script: |
    curl -sLf https://gitlab.com/uniget-org/cli/-/releases/permalink/latest/downloads/uniget_Linux_$(uname -m).tar.gz \
    | tar -xzC /usr/local/bin uniget

.go-cache:
  variables:
    GOPATH: $CI_PROJECT_DIR/.go
  before_script:
    - mkdir -p .go
  cache:
    paths:
      - .go/pkg/mod/

uniget-dev:
  rules:
  - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  - if: $CI_PIPELINE_SOURCE == "web"
  extends:
  - .go-cache
  variables:
    GIT_CHECKOUT: false
  image: golang:1.26.0@sha256:c83e68f3ebb6943a2904fa66348867d108119890a2c6a2e6f07b38d0eb6c25c5
  script: |
    git clone https://gitlab.com/uniget-org/cli
    cd cli
    COMMIT_SHA="$( git rev-parse --short HEAD )"
    
    CGO_ENABLED=0 go build -ldflags "-w -s -X main.version=${COMMIT_SHA}" -o ../dev ./cmd/dev/
  artifacts:
    paths:
    - dev

collect:
  rules:
  - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  - if: $CI_PIPELINE_SOURCE == "web"
  needs:
  - uniget-dev
  image: alpine:3.23.3@sha256:25109184c71bdad752c8312a8623239686a9a2071e8825f20acb8f2198c3f659
  script: |
    ./dev --debug metadata changes

#metadata:
#  rules:
#  - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
#  needs:
#  - collect
#  extends:
#  - .docker_login
#  - .dind
#  - .docker_logout
#  image: docker:29.2.1@sha256:8bcbad4b45f0bff9d3e809d85a7ac589390f0be8acbc526850c998c35c1243fd
#  script:
#  - apk add --update-cache \
#        curl \
#        make \
#        bash
#  - !reference [.uniget, script]
#  - make metadata.json--push REGISTRY=${CI_REGISTRY}
